# Исправления проблем в TutorSlot Bot

## Исправленные проблемы

### 1. Отмена занятия не синхронизируется с Google Calendar
**Проблема**: При отмене занятия через бота событие не удалялось из Google Calendar.

**Решение**: Обновлен метод `admin_cancel` в `BookingService` для правильного удаления события из календаря перед удалением записи из базы данных.

### 2. Изменения в боте не отражаются в календаре
**Проблема**: При изменении даты, времени, имени или контакта события в Google Calendar не обновлялись.

**Решение**: 
- Обновлен метод `reschedule_to` для синхронизации изменений времени
- Обновлен метод `admin_update_content` для синхронизации изменений имени и контакта
- При изменении контакта старое событие удаляется и создается новое с новым контактом
- Заменен метод `patch` на `update` для полного обновления событий
- Добавлено подробное логирование для отслеживания всех операций

### 3. Неправильное время отправки напоминаний
**Проблема**: Напоминания приходили не за 24 часа и 1 час до занятия, а раньше.

**Решение**: Добавлена дополнительная проверка в `ReminderService` чтобы напоминания не планировались для занятий которые уже прошли или слишком близко.

### 4. Улучшена интеграция с Google Calendar
**Проблема**: Интеграция с Google Calendar была неполной (только TODO).

**Решение**: 
- Полностью реализован класс `GoogleCalendar` с использованием `GoogleCalendarService`
- Добавлены настройки событий для правильной работы с приглашениями
- Добавлены встроенные напоминания в календаре (24 часа и 1 час)
- Улучшена обработка ошибок и логирование

### 5. События не обновляются при изменении информации
**Проблема**: При изменении имени ученика или контакта в боте, информация в Google Calendar оставалась старой.

**Решение**:
- Заменен метод `patch` на `update` в Google Calendar API для полного обновления событий
- Добавлено подробное логирование всех операций обновления
- Улучшена обработка ошибок при обновлении событий
- Добавлены дополнительные поля в события (цвет, улучшенное описание)

### 6. Изменения не отражаются в календаре у организатора и ученика
**Проблема**: При изменении информации в боте, события в Telegram обновлялись, но в Google Calendar (как у организатора, так и у ученика) изменения не отражались. Приходили только письма с уведомлением об изменениях, но сами события не менялись.

**Решение**:
- Заменен подход обновления на полное пересоздание событий
- При любых изменениях (имя, контакт, время) старое событие удаляется и создается новое
- Это гарантирует что изменения отразятся в календаре у всех участников
- Улучшены настройки уведомлений (`sendUpdates="all"`)
- Добавлено подробное логирование всех операций пересоздания
- Добавлено принудительное обновление календаря с задержкой
- Добавлена проверка прав доступа к календарю
- Улучшены настройки событий для избежания кэширования
- При изменении времени передается новое время, а не старое из базы данных

## Настройка для правильной работы

### 1. Переменные окружения
Создайте файл `.env` со следующими настройками:

```bash
# Основные настройки бота
BOT_TOKEN=your_bot_token_here
TZ=Europe/Moscow
ADMINS=123456789,987654321

# Настройки Google Calendar
GOOGLE_CALENDAR_ENABLED=true
GOOGLE_CALENDAR_ID=primary
GOOGLE_CREDENTIALS_JSON_PATH=./integrations/credentials.json
GOOGLE_OAUTH_TOKEN_PATH=./integrations/token.json

# Настройки напоминаний (в минутах)
REMINDERS_ENABLED=true
REMIND_OFFSETS_MINUTES=1440,60
```

### 2. Настройка Google Calendar
1. Скачайте `credentials.json` из Google Cloud Console
2. Запустите один раз: `python -m app.integrations.google_oauth_setup`
3. В результате появится `token.json`

### 3. Проверка работы
После исправлений:
- При отмене занятия событие автоматически удаляется из Google Calendar
- При изменении времени/даты событие пересоздается в календаре
- При изменении контакта старое приглашение отменяется и отправляется новое
- При изменении имени ученика событие пересоздается в календаре
- Все изменения теперь отражаются в календаре у организатора и ученика
- Напоминания приходят точно за 24 часа и 1 час до занятия
- В календаре появляются встроенные напоминания

## Логирование
Добавлено подробное логирование для отслеживания операций с Google Calendar:
- Создание событий
- Обновление событий  
- Удаление событий
- Ошибки при работе с API
- Детальная информация об ошибках
- Подробное логирование всех операций обновления

## Улучшения Google Calendar
- События создаются с правильными настройками приватности
- Добавлены встроенные напоминания в календаре
- Правильная обработка ошибок API
- Сохранение важных полей при обновлении событий
- Автоматическая отправка уведомлений участникам
- Использование метода `update` вместо `patch` для полного обновления
- Добавлены цвета и улучшенные описания событий

## Файлы изменений
- `app/services/booking_service.py` - исправлена логика работы с Google Calendar
- `app/integrations/google_calendar.py` - реализована реальная интеграция
- `app/services/reminder_service.py` - исправлена логика планирования напоминаний
- `app/services/google_calendar_service.py` - улучшена обработка ошибок и настройки событий
- `scripts/test_force_update.py` - скрипт для тестирования принудительного обновления
- `scripts/test_time_change.py` - скрипт для тестирования изменения времени событий
- `scripts/check_permissions.py` - скрипт для проверки прав доступа к календарю

## Тестирование
После внесения изменений рекомендуется:
1. **ВАЖНО**: Запустить `python scripts/check_permissions.py` для проверки прав доступа
2. Создать тестовое бронирование
3. Проверить что событие появилось в Google Calendar
4. Изменить время/дату и проверить пересоздание события в календаре
5. Изменить имя ученика и проверить пересоздание события в календаре
6. Изменить контакт и проверить отправку нового приглашения
7. Отменить бронирование и проверить удаление из календаря
8. Проверить что напоминания приходят в правильное время
9. Запустить `python scripts/test_force_update.py` для тестирования принудительного обновления
10. Запустить `python scripts/test_time_change.py` для тестирования изменения времени событий

## Отладка проблем
Если события все еще не обновляются:
1. **ВАЖНО**: Сначала запустите `python scripts/check_permissions.py` для проверки прав доступа
2. Проверьте логи на наличие ошибок
3. Убедитесь что `GOOGLE_CALENDAR_ENABLED=true`
4. Проверьте что у бота есть права на редактирование календаря
5. Запустите тестовый скрипт для проверки API: `python scripts/test_force_update.py`
6. Проверьте что `credentials.json` и `token.json` актуальны
7. Если права доступа не определены, используйте тестовое создание события для проверки

## Решение проблем с правами доступа
Если скрипт `check_permissions.py` показывает "UNKNOWN" права:
1. Запустите `python -m app.integrations.google_oauth_setup` для пересоздания токена
2. Убедитесь что `credentials.json` находится в правильной папке (`app/integrations/`)
3. Проверьте что у Google аккаунта есть права на редактирование календаря
4. В Google Calendar настройках убедитесь что календарь доступен для редактирования
